<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Thomas Monks, Alison Harper">

<title>S.T.A.R.S - Model code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../02_model/01_model.html"><code>simmer</code> code</a></li><li class="breadcrumb-item"><a href="../02_model/01_model.html">Model code</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">S.T.A.R.S</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TomMonks/treat-sim-rsimmer">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TomMonks/treat-sim-rsimmer/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Abstract</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_introduction/02_license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text"><code>simmer</code> code</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_model/01_model.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Model code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_model/02_thinning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time-dependent arrivals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_model/03_r_sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampling in R</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">1. Imports</a></li>
  <li><a href="#default-values-and-constants" id="toc-default-values-and-constants" class="nav-link" data-scroll-target="#default-values-and-constants">2. Default values and constants</a>
  <ul class="collapse">
  <li><a href="#distribution-parameters" id="toc-distribution-parameters" class="nav-link" data-scroll-target="#distribution-parameters">2.1 Distribution parameters</a></li>
  <li><a href="#time-dependent-arrival-rate-data" id="toc-time-dependent-arrival-rate-data" class="nav-link" data-scroll-target="#time-dependent-arrival-rate-data">2.2 Time dependent arrival rate data</a></li>
  <li><a href="#resource-counts" id="toc-resource-counts" class="nav-link" data-scroll-target="#resource-counts">2.3 Resource Counts</a></li>
  <li><a href="#simulation-model-run-settings" id="toc-simulation-model-run-settings" class="nav-link" data-scroll-target="#simulation-model-run-settings">2.4 Simulation model run settings</a></li>
  </ul></li>
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions">3. Functions</a></li>
  <li><a href="#model-parameterisation" id="toc-model-parameterisation" class="nav-link" data-scroll-target="#model-parameterisation">4. Model parameterisation</a></li>
  <li><a href="#patient-trajectories" id="toc-patient-trajectories" class="nav-link" data-scroll-target="#patient-trajectories">5. Patient Trajectories</a>
  <ul class="collapse">
  <li><a href="#trauma-patients" id="toc-trauma-patients" class="nav-link" data-scroll-target="#trauma-patients">5.1. Trauma Patients</a></li>
  <li><a href="#non-trauma-patients" id="toc-non-trauma-patients" class="nav-link" data-scroll-target="#non-trauma-patients">5.2 Non-trauma patients</a></li>
  </ul></li>
  <li><a href="#modelling-patient-arrivals" id="toc-modelling-patient-arrivals" class="nav-link" data-scroll-target="#modelling-patient-arrivals">6. Modelling patient arrivals</a></li>
  <li><a href="#single-run-of-the-model" id="toc-single-run-of-the-model" class="nav-link" data-scroll-target="#single-run-of-the-model">7. Single run of the model</a></li>
  <li><a href="#multiple-replications" id="toc-multiple-replications" class="nav-link" data-scroll-target="#multiple-replications">8. Multiple replications</a></li>
  <li><a href="#results-analysis" id="toc-results-analysis" class="nav-link" data-scroll-target="#results-analysis">9. Results analysis</a>
  <ul class="collapse">
  <li><a href="#waiting-time-kpis" id="toc-waiting-time-kpis" class="nav-link" data-scroll-target="#waiting-time-kpis">9.1. Waiting time KPIs</a></li>
  <li><a href="#resource-utilisation-kpis" id="toc-resource-utilisation-kpis" class="nav-link" data-scroll-target="#resource-utilisation-kpis">9.2. Resource utilisation KPIs</a></li>
  <li><a href="#patient-arrival-numbers-output" id="toc-patient-arrival-numbers-output" class="nav-link" data-scroll-target="#patient-arrival-numbers-output">9.3. Patient arrival numbers output</a></li>
  <li><a href="#system-level-kpis" id="toc-system-level-kpis" class="nav-link" data-scroll-target="#system-level-kpis">9.4 System level KPIs</a></li>
  <li><a href="#function-to-create-the-replications-table" id="toc-function-to-create-the-replications-table" class="nav-link" data-scroll-target="#function-to-create-the-replications-table">9.5. Function to create the replications table</a></li>
  <li><a href="#histogram-of-replications" id="toc-histogram-of-replications" class="nav-link" data-scroll-target="#histogram-of-replications">9.6 Histogram of replications</a></li>
  <li><a href="#results-summary-table" id="toc-results-summary-table" class="nav-link" data-scroll-target="#results-summary-table">9.7 Results summary table</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/TomMonks/treat-sim-rsimmer/edit/main/02_model/01_model.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/TomMonks/treat-sim-rsimmer/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model code</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Thomas Monks, Alison Harper </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">1. Imports</h2>
<blockquote class="blockquote">
<p>Note: we are calculating KPIs using our own code here, but you can also use <code>simmer.plot</code>. Help with install of <code>simmer.plot</code> (<code>igraph</code> installation is the actual issue) on Linux based systems: <a href="https://r.igraph.org/articles/installation-troubleshooting#cannot-compile-igraph-from-sources-on-linux" class="uri">https://r.igraph.org/articles/installation-troubleshooting#cannot-compile-igraph-from-sources-on-linux</a></p>
<blockquote class="blockquote">
<p>If you make use of conda environments (via Anaconda/mini-conda/mini-forge/mamba), <strong>remember</strong> to <code>conda deactivate</code> before installation.</p>
</blockquote>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(simmer.bricks)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(simmer.plot))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(RCurl))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(Rlab))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(dplyr))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(tidyr))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="default-values-and-constants" class="level2">
<h2 class="anchored" data-anchor-id="default-values-and-constants">2. Default values and constants</h2>
<section id="distribution-parameters" class="level3">
<h3 class="anchored" data-anchor-id="distribution-parameters">2.1 Distribution parameters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Mean and Variance of the underlying Normal Distribution</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' `normal_moments_from_lognormal` calculates the mu and sigma</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' of the normal distribution underlying a lognormal</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' mean and standard </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' `rlnorm` from `stats` is designed to sample from the lognormal distribution. </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' The parameters is expects are moments of the underlying normal distribution</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' Using sample mean and standard deviation this function calculates </span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' the mu and sigma of the normal distribution. source: https://blogs.sas.com/content/iml/2014/06/04/simulate-lognormal-data-with-specified-mean-and-variance.html</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mean A number. Sample mean.</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param stdev A number. Sample standard deviation</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A list </span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>normal_moments_from_lognormal <span class="ot">&lt;-</span> <span class="cf">function</span>(mean, std){</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(std<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> mean<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">log</span>(mean<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>phi)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">log</span>(phi<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>mean<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"mu"</span> <span class="ot">=</span> mu, <span class="st">"sigma"</span> <span class="ot">=</span> sigma))</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sign-in/triage parameters</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>DEFAULT_TRIAGE_MEAN <span class="ot">&lt;-</span> <span class="fl">3.0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># registration parameters (lognormal distribution)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>DEFAULT_REG_PARAMS <span class="ot">&lt;-</span> <span class="fu">normal_moments_from_lognormal</span>(<span class="fl">5.0</span>, <span class="fu">sqrt</span>(<span class="fl">2.0</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># examination parameters</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>DEFAULT_EXAM_PARAMS <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mean=</span><span class="fl">16.0</span>, <span class="at">var=</span><span class="fl">3.0</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># trauma/stabilisation</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>DEFAULT_TRAUMA_MEAN <span class="ot">&lt;-</span> <span class="fl">90.0</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Trauma treatment (lognormal distribution)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>DEFAULT_TRAUMA_TREATMENT_PARAMS <span class="ot">&lt;-</span> <span class="fu">normal_moments_from_lognormal</span>(<span class="fl">30.0</span>, <span class="fu">sqrt</span>(<span class="fl">4.0</span>))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Non trauma treatment (lognormal distribution)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>DEFAULT_NON_TRAUMA_TREATMENT_PARAMS <span class="ot">&lt;-</span> <span class="fu">normal_moments_from_lognormal</span>(<span class="fl">13.3</span>, <span class="fu">sqrt</span>(<span class="fl">2.0</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># prob patient requires treatment given trauma</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>DEFAULT_NON_TRAUMA_TREAT_P <span class="ot">&lt;-</span> <span class="fl">0.60</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># proportion of patients triaged as trauma</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>DEFAULT_PROB_TRAUMA <span class="ot">&lt;-</span> <span class="fl">0.12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="time-dependent-arrival-rate-data" class="level3">
<h3 class="anchored" data-anchor-id="time-dependent-arrival-rate-data">2.2 Time dependent arrival rate data</h3>
<p>The data for arrival rates varies between clinic opening at 6am and closure at 12am.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data are held in the Github repo and loaded from there.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>NSPP_PATH <span class="ot">=</span> <span class="st">'https://raw.githubusercontent.com/TomMonks/open-science-for-sim/main/src/notebooks/01_foss_sim/data/ed_arrivals.csv'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>csv_data <span class="ot">&lt;-</span> <span class="fu">getURL</span>(NSPP_PATH)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">text=</span>csv_data)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># lock in order of time of day for bar chart display</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>period, <span class="at">levels =</span> df<span class="sc">$</span>period)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>df, <span class="fu">aes</span>(<span class="at">x=</span>period, <span class="at">y=</span>arrival_rate)) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">fill=</span><span class="st">"steelblue"</span>) <span class="sc">+</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">vjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">hjust=</span><span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Hour of day"</span>) <span class="sc">+</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Mean arrivals (patients/hr)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01_model_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="resource-counts" class="level3">
<h3 class="anchored" data-anchor-id="resource-counts">2.3 Resource Counts</h3>
<p>Integer count variables representing the number of resources at each activity in the process</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>DEFAULT_N_TRIAGE <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>DEFAULT_N_REG <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>DEFAULT_N_EXAM <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># stabilisation rooms</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>DEFAULT_N_TRAUMA <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-trauma cubicles</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>DEFAULT_NON_TRAUMA_CUBICLES <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># trauma pathway cubicles</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>DEFAULT_TRAUMA_CUBICLES <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulation-model-run-settings" class="level3">
<h3 class="anchored" data-anchor-id="simulation-model-run-settings">2.4 Simulation model run settings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Random seed - this will be investigated for CRN</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>SEED <span class="ot">&lt;-</span> <span class="dv">42</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># default results collection period</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>DEFAULT_RESULTS_COLLECTION_PERIOD <span class="ot">&lt;-</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">19</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># number of replications.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>DEFAULT_N_REPS <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the a trace of simulated events</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 = show, 0 = do not show.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>LOG_LEVEL <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="functions" class="level2">
<h2 class="anchored" data-anchor-id="functions">3. Functions</h2>
<p>Load and format data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>load_arrival_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">path=</span>NSPP_PATH){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  csv_data <span class="ot">&lt;-</span> <span class="fu">getURL</span>(NSPP_PATH)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">text=</span>csv_data)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># arrivals per minute...</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>arrival_rate2 <span class="ot">&lt;-</span> df<span class="sc">$</span>arrival_rate<span class="sc">/</span><span class="fl">60.0</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create 60 minute increments for period</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>period <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, (<span class="fu">nrow</span>(df)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">*</span><span class="dv">60</span>, <span class="at">by=</span><span class="dv">60</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sample a patient type</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' `sample_arrival_type` samples if a patient type is trauma or non-trauma</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' with a given probability.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function uses the Bernouli distribution (Rlab) to sample</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' if a patient is Trauma or Non-Trauma.  The return values are </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' 1 = Trauma, 2 = Non-trauma.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p A number: the probability a patient has trauma on arrival</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>sample_arrival_type <span class="ot">&lt;-</span> <span class="cf">function</span>(p, <span class="at">n=</span><span class="dv">1</span>){</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">rbern</span>(n, <span class="at">prob =</span> DEFAULT_PROB_TRAUMA) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sample a if a non-trauma patient requires treatment</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' `sample_nt_trauma_treatment` samples if a non-trauma patient</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' requires cubicle treatment</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function uses the Bernouli distribution (Rlab) to sample</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' if a patient is requires treatment or not.  The return values are </span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' 1 = Treatment, 0 = No treatment</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p A number: The probability the patient requires treatment</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>sample_nt_trauma_treatment <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">rbern</span>(<span class="dv">1</span>, <span class="at">prob =</span> p) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sampling from a non-stationary poisson process using thinning</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nspp_thinning <span class="ot">&lt;-</span> <span class="cf">function</span>(simulation_time, data, <span class="at">debug=</span><span class="cn">FALSE</span>){</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calc time interval: assumes intervals are of equal length</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  interval <span class="ot">&lt;-</span> data<span class="sc">$</span>period[<span class="dv">2</span>] <span class="sc">-</span> data<span class="sc">$</span>period[<span class="dv">1</span>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># maximum arrival rate (smallest time between arrivals)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  lambda_max <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>arrival_rate2)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(<span class="cn">TRUE</span>){</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get time bucket (row of dataframe to use)</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> <span class="fu">floor</span>(simulation_time <span class="sc">/</span> interval) <span class="sc">%%</span> <span class="fu">nrow</span>(data) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    lambda_t <span class="ot">&lt;-</span> data<span class="sc">$</span>arrival_rate2[t]</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set to a large number so that at least 1 sample is taken</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    rejects <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># running total of time until next arrival</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    inter_arrival_time <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reject proportionate to lambda_t / lambda_max</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    ratio <span class="ot">&lt;-</span> lambda_t <span class="sc">/</span> lambda_max</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(u <span class="sc">&gt;=</span> ratio){</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>      rejects <span class="ot">&lt;-</span> rejects <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># sample using max arrival rate</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>      inter_arrival_time <span class="ot">&lt;-</span> inter_arrival_time <span class="sc">+</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_max)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(debug){</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>({<span class="fu">paste</span>(<span class="st">"Time:"</span>, simulation_time, </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" Rejections:"</span>, rejects, </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" t:"</span>, t, </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" lambda_t:"</span>, lambda_t, </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" IAT:"</span>, inter_arrival_time)})</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(inter_arrival_time)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-parameterisation" class="level2">
<h2 class="anchored" data-anchor-id="model-parameterisation">4. Model parameterisation</h2>
<p>The model is setup to be created from a set of functions that return trajectories. Each function accepts a list that contains all parameters to configure the simulation model. Here we create the list and pre-populate it using default values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>create_experiment <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_triage_bays=</span>DEFAULT_N_TRIAGE,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_reg_clerks=</span>DEFAULT_N_REG,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_exam_rooms=</span>DEFAULT_N_EXAM,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_trauma_rooms=</span>DEFAULT_N_TRAUMA,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_non_trauma_cubicles=</span>DEFAULT_NON_TRAUMA_CUBICLES,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_trauma_cubicles=</span>DEFAULT_TRAUMA_CUBICLES,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">triage_mean=</span>DEFAULT_TRIAGE_MEAN,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">stabilisation_mean=</span>DEFAULT_TRAUMA_MEAN,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">trauma_treat_params=</span>DEFAULT_TRAUMA_TREATMENT_PARAMS,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">reg_params=</span>DEFAULT_REG_PARAMS,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">exam_params=</span>DEFAULT_EXAM_PARAMS,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prob_non_trauma_treat=</span>DEFAULT_NON_TRAUMA_TREAT_P,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nontrauma_treat_params=</span>DEFAULT_NON_TRAUMA_TREATMENT_PARAMS,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prob_trauma=</span>DEFAULT_PROB_TRAUMA,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">arrival_data_path=</span>NSPP_PATH,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">log_level=</span>LOG_LEVEL) {</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load arrival data</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  arrival_data <span class="ot">&lt;-</span> <span class="fu">load_arrival_data</span>(<span class="at">path=</span>arrival_data_path)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create list of parameters</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  experiment <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n_triage_bays=</span>n_triage_bays,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n_reg_clerks=</span>n_reg_clerks,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n_exam_rooms=</span>n_exam_rooms,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n_trauma_rooms=</span>n_trauma_rooms,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n_non_trauma_cubicles=</span>n_non_trauma_cubicles,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n_trauma_cubicles=</span>n_trauma_cubicles,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                    <span class="at">triage_mean=</span>triage_mean,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                    <span class="at">stabilisation_mean=</span>stabilisation_mean,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">trauma_treat_params=</span>trauma_treat_params,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                    <span class="at">reg_params=</span>reg_params,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                    <span class="at">exam_params=</span>exam_params,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prob_non_trauma_treat=</span>prob_non_trauma_treat,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nontrauma_treat_params=</span>nontrauma_treat_params,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prob_trauma=</span>prob_trauma,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                    <span class="at">arrival_data=</span>arrival_data,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                    <span class="at">log_level=</span>log_level)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(experiment)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>}     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="patient-trajectories" class="level2">
<h2 class="anchored" data-anchor-id="patient-trajectories">5. Patient Trajectories</h2>
<p>The DES package <code>simmer</code> uses the concept of a <code>trajectory</code> to model a process for a particular patient type. In the urgent care centre example trajectories allow us to model separate trauma and non-trauma processes. Note that different trajectories can share common resources.</p>
<p>The <code>simmer</code> terminology for using resources and engaging in activities is easy to read:</p>
<ul>
<li><p><code>seize</code> - queue and take a resource when it is available.</p></li>
<li><p><code>timeout</code> - a process delay (e.g.&nbsp;treatment or diagnostics)</p></li>
<li><p><code>release</code> - release a resource.</p></li>
</ul>
<p><code>simmer</code> also provides a way to set an attribute of the <code>trajectory</code> using <code>set_attribute</code>. This is useful for storing timing information to display in a log: for example when a patient begins waiting for a resource (access via <code>now(env)</code>).</p>
<blockquote class="blockquote">
<p><strong>Important notes:</strong></p>
<ol type="1">
<li>The function <code>log_</code> is used in combination with <code>function()</code> <code>paste</code> to provide a dynamic simulation trace to the R console.</li>
<li>Sampling code should look as follows:</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">timeout</span>(<span class="at">task =</span> <span class="cf">function</span>() <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="fl">3.0</span>)) <span class="sc">%&gt;%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>The keyword <code>function()</code> must be included for dynamic sampling for each patient. <strong>Omitting</strong> <code>function()</code> means that it is evaluated <strong>once</strong> at the time the <code>trajectory</code> is created.</p>
</blockquote>
</blockquote>
<section id="trauma-patients" class="level3">
<h3 class="anchored" data-anchor-id="trauma-patients">5.1. Trauma Patients</h3>
<blockquote class="blockquote">
<p>We wrap the trajectory in a function called <code>create_trauma_pathway</code>. This allows us to pass an argument <code>exp</code> that can parameterise the trajectory for use in a discrete experiment.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>create_trauma_pathway <span class="ot">&lt;-</span> <span class="cf">function</span>(exp){</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    trauma_pathway <span class="ot">&lt;-</span> <span class="fu">trajectory</span>(<span class="at">name=</span><span class="st">"trauma_pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_attribute</span>(<span class="st">"patient_type"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># log patient arrival</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"**Trauma arrival"</span>)}, <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># triage </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_attribute</span>(<span class="st">"start_triage_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">visit</span>(<span class="st">"triage_bay"</span>, <span class="cf">function</span>() <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>exp<span class="sc">$</span>triage_mean)) <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"(T) Triage wait time:"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_triage_wait"</span>))},</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># request trauma room for stabilization</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_attribute</span>(<span class="st">"start_trauma_room_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">visit</span>(<span class="st">"trauma_room"</span>, <span class="cf">function</span>() <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>exp<span class="sc">$</span>stabilisation_mean)) <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"(T) Trauma room wait time:"</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_trauma_room_wait"</span>))},</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># request treatment cubicle</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_attribute</span>(<span class="st">"start_trauma_treat_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">visit</span>(<span class="st">"trauma_treat_cubicle"</span>, <span class="cf">function</span>() <span class="fu">rlnorm</span>(<span class="dv">1</span>, exp<span class="sc">$</span>trauma_treat_params<span class="sc">$</span>mu,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                                                      exp<span class="sc">$</span>trauma_treat_params<span class="sc">$</span>sigma)) <span class="sc">%&gt;%</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"********************(T) Trauma treatment cubicle wait time:"</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_trauma_treat_wait"</span>))},</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># store the total time in system </span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_attribute</span>(<span class="st">"total_time"</span>, </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_triage_wait"</span>)})</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(trauma_pathway)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="non-trauma-patients" class="level3">
<h3 class="anchored" data-anchor-id="non-trauma-patients">5.2 Non-trauma patients</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>create_nt_cubicle_treatment <span class="ot">&lt;-</span> <span class="cf">function</span>(exp){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  nt_cubicle_treatment <span class="ot">&lt;-</span> <span class="fu">trajectory</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"NT patient requirement treatment"</span>)},</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seize</span>(<span class="at">resource=</span><span class="st">"nontrauma_treat_cubicle"</span>, <span class="at">amount=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">timeout</span>(<span class="at">task =</span> <span class="cf">function</span>() <span class="fu">rlnorm</span>(<span class="dv">1</span>, exp<span class="sc">$</span>nontrauma_treat_params<span class="sc">$</span>mu,                                                     exp<span class="sc">$</span>nontrauma_treat_params<span class="sc">$</span>sigma)) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">release</span>(<span class="at">resource =</span> <span class="st">"nontrauma_treat_cubicle"</span>, <span class="at">amount =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">"NT treatment complete"</span>)},</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nt_cubicle_treatment)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>create_non_trauma_pathway <span class="ot">&lt;-</span> <span class="cf">function</span>(exp){</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log messages</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  ARRIVAL_MSG <span class="ot">=</span> <span class="st">"**Non-Trauma arrival**"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  TRIAGE_MSG <span class="ot">=</span> <span class="st">"(NT) Triage wait time:"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  REG_MSG <span class="ot">=</span> <span class="st">"Reg wait time:"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  EXAM_MSG <span class="ot">=</span> <span class="st">"Exam wait time:"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  EXIT_MSG <span class="ot">=</span> <span class="st">"NT Total time in system:"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># optional trajectory for proportion of patients that requirement treatment</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  nt_cubicle_treatment <span class="ot">&lt;-</span> <span class="fu">create_nt_cubicle_treatment</span>(exp)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  non_trauma_pathway <span class="ot">&lt;-</span> <span class="fu">trajectory</span>(<span class="at">name=</span><span class="st">"non_trauma_pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"patient_type"</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log non_trauma arrival</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(ARRIVAL_MSG)}, <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store start of waiting time for log calculations</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"start_triage_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># queue and use triage bay</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">visit</span>(<span class="st">"triage_bay"</span>, <span class="cf">function</span>() <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>exp<span class="sc">$</span>triage_mean)) <span class="sc">%&gt;%</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(TRIAGE_MSG, <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_triage_wait"</span>))},</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># queue and use registration clerk</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"start_reg_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">visit</span>(<span class="st">"registration_clerk"</span>, <span class="cf">function</span>() <span class="fu">rlnorm</span>(<span class="dv">1</span>, exp<span class="sc">$</span>reg_params<span class="sc">$</span>mu, </span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>                                                  exp<span class="sc">$</span>reg_params<span class="sc">$</span>sigma)) <span class="sc">%&gt;%</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(REG_MSG, <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_reg_wait"</span>))},</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># queue and use examination room</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"start_exam_wait"</span>, <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env)}) <span class="sc">%&gt;%</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">visit</span>(<span class="st">"examination_room"</span>,  <span class="cf">function</span>() <span class="fu">rnorm</span>(<span class="dv">1</span>, exp<span class="sc">$</span>exam_params<span class="sc">$</span>mean, </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">sqrt</span>(exp<span class="sc">$</span>exam_params<span class="sc">$</span>var))) <span class="sc">%&gt;%</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(EXAM_MSG, <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_exam_wait"</span>))},</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a Proportion of patients require treatment in a cubicle</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span> (</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>() <span class="fu">sample_nt_trauma_treatment</span>(exp<span class="sc">$</span>prob_non_trauma_treat), <span class="at">continue=</span>T,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>      nt_cubicle_treatment</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(EXIT_MSG, <span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_triage_wait"</span>))},</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store the total time in system </span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"total_time"</span>, </span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>() {<span class="fu">now</span>(exp<span class="sc">$</span>env) <span class="sc">-</span> <span class="fu">get_attribute</span>(exp<span class="sc">$</span>env, <span class="st">"start_triage_wait"</span>)})</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(non_trauma_pathway)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="modelling-patient-arrivals" class="level2">
<h2 class="anchored" data-anchor-id="modelling-patient-arrivals">6. Modelling patient arrivals</h2>
<p>Patients arrive a the urgent treatment centre following a time dependent process. When patients arrive they are classified as trauma or non-trauma.</p>
<p>To modify the classification of patients we will use a trajectory that uses the `branch` function from <code>simmer</code>.</p>
<p>The function `sample_arrival_type` returns a 1 (trauma) or 2 (non-trauma). This is used to select the appropriate patient trajectory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>create_arrival_generator <span class="ot">&lt;-</span> <span class="cf">function</span>(exp){</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  DEPART_MSG <span class="ot">&lt;-</span> <span class="st">"A patient has departed the UTC"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create and parameterise the trauma pathway trajectory</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  trauma_pathway <span class="ot">&lt;-</span> <span class="fu">create_trauma_pathway</span>(exp)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create and parameterise the non-trauma pathway trajectory</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  non_trauma_pathway <span class="ot">&lt;-</span> <span class="fu">create_non_trauma_pathway</span>(exp)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  patient_arrival <span class="ot">&lt;-</span> <span class="fu">trajectory</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>() <span class="fu">sample_arrival_type</span>(exp<span class="sc">$</span>prob_trauma), <span class="at">continue=</span>T,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        trauma_pathway,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        non_trauma_pathway</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(DEPART_MSG)},<span class="at">level=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"departed"</span>, <span class="dv">1</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(patient_arrival)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="single-run-of-the-model" class="level2">
<h2 class="anchored" data-anchor-id="single-run-of-the-model">7. Single run of the model</h2>
<blockquote class="blockquote">
<p>Work in progress</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>single_run <span class="ot">&lt;-</span> <span class="cf">function</span>(env, exp, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">rep_number=</span><span class="dv">1</span>, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_length=</span>DEFAULT_RESULTS_COLLECTION_PERIOD, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">debug_arrivals=</span><span class="cn">FALSE</span>){</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the simmer environment to the experiment list.</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  exp <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, <span class="at">env=</span>env) </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the arrivals generator</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  arrival_gen <span class="ot">&lt;-</span> <span class="fu">create_arrival_generator</span>(exp)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create model and run.</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  env <span class="sc">%&gt;%</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"triage_bay"</span>, exp<span class="sc">$</span>n_triage_bays) <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"registration_clerk"</span>, exp<span class="sc">$</span>n_reg_clerks) <span class="sc">%&gt;%</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"examination_room"</span>, exp<span class="sc">$</span>n_exam_rooms) <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"trauma_room"</span>, exp<span class="sc">$</span>n_trauma_rooms) <span class="sc">%&gt;%</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"trauma_treat_cubicle"</span>, exp<span class="sc">$</span>n_trauma_cubicles) <span class="sc">%&gt;%</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">"nontrauma_treat_cubicle"</span>, exp<span class="sc">$</span>n_non_trauma_cubicles) <span class="sc">%&gt;%</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_generator</span>(<span class="st">"Patient"</span>, arrival_gen, </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>() <span class="fu">nspp_thinning</span>(<span class="fu">now</span>(env), exp<span class="sc">$</span>arrival_data, </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">debug=</span>debug_arrivals),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mon=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run</span>(<span class="at">until=</span>run_length)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return environment and all of its results.</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(env)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Script to conduct single run of the model</p>
<blockquote class="blockquote">
<p>Note that the environment is created outside of the <code>single_run</code> function. This is to separate the creation of the environment from the <code>run</code> function call. The reason is so that the <code>now(env)</code> function will work correctly in the <code>nspp_thinning</code> sampling function (if we do not separate then the same time is always passed to the function).</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(SEED)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>exp <span class="ot">&lt;-</span> <span class="fu">create_experiment</span>(<span class="at">log_level=</span><span class="dv">0</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>treat_sim <span class="ot">&lt;-</span> <span class="fu">simmer</span>(<span class="st">"TreatSim"</span>, <span class="at">log_level=</span>exp<span class="sc">$</span>log_level)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>treat_sim <span class="ot">&lt;-</span> <span class="fu">single_run</span>(treat_sim, exp)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Simulation Complete."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Simulation Complete."</code></pre>
</div>
</div>
</section>
<section id="multiple-replications" class="level2">
<h2 class="anchored" data-anchor-id="multiple-replications">8. Multiple replications</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>multiple_replications <span class="ot">&lt;-</span> <span class="cf">function</span>(exp, <span class="at">n_reps=</span><span class="dv">5</span>, <span class="at">random_seed=</span><span class="dv">0</span>){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set seed in once place.  No CRN</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(random_seed)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note unlike in simmer documentation we use a traditional for loop</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># instead of lapply. This allows us to separate env creation</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># from run and preserve the environment interaction between NSPP </span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and current sim time.</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># TO DO: look again -&gt; can treat_sim be created inside single_run()</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"running replications..."</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  reps <span class="ot">=</span> <span class="fu">vector</span>()</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps){</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    treat_sim <span class="ot">&lt;-</span> <span class="fu">simmer</span>(<span class="st">"TreatSimmer"</span>, <span class="at">log_level=</span>exp<span class="sc">$</span>log_level)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    treat_sim <span class="ot">&lt;-</span> <span class="fu">single_run</span>(treat_sim, exp)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store the latest simulation environment and its results.</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    reps <span class="ot">&lt;-</span> <span class="fu">c</span>(reps, treat_sim)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"Complete."</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(reps)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create experiment</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>exp <span class="ot">&lt;-</span> <span class="fu">create_experiment</span>(<span class="at">log_level=</span><span class="dv">0</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># run 50 replications of the model</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>reps <span class="ot">&lt;-</span> <span class="fu">multiple_replications</span>(exp, <span class="at">n_reps=</span><span class="dv">50</span>, <span class="at">random_seed=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "running replications..."
[1] "Complete."</code></pre>
</div>
</div>
</section>
<section id="results-analysis" class="level2">
<h2 class="anchored" data-anchor-id="results-analysis">9. Results analysis</h2>
<p>Analysis of <code>simmer</code> results is achieved using a mix of statistics collected automatically and custom attributes set by the modeller during the run.</p>
<p>In general, we follow a typical strategy in a simulation study. We calculate the mean Key Performance Indicator (KPI) seen during an individual replication of the model (e.g.&nbsp;waiting time for triage and utilisation of the the triage rooms). This is repeated for all replications and the distribution of results can be visualised or we use a summary measure such as the mean.</p>
<p>Below we construct a summary table of results providing the mean of 16 KPIs.</p>
<p>We assemble the table of KPIs across replications using the following key functions</p>
<ul>
<li><p><code>resource_waiting_times_by_replication</code> - creates a data frame where columns report the mean waiting time within a replication for a activity in the model (e.g.&nbsp;triage waiting time)</p></li>
<li><p><code>resource_utilisation_by_replication</code> - creates a data frame where columns report the utilisation of a resource within a replication (e.g.&nbsp;the proportion of the scheduled time that triage bays are in use).</p></li>
<li><p><code>arrivals_by_replication</code> - creates a data frame of the total number of patient arrivals in a replication.</p></li>
<li><p><code>system_kpi_by_replication</code> - creates a data frame containing system level KPIs by replication e.g.&nbsp;throughput and time in system (created from custom attributes).</p></li>
<li><p><code>replication_results_table</code> - creates the overall data frame using the other functions.</p></li>
</ul>
<blockquote class="blockquote">
<p>Code quality is a work in progress. </p>
</blockquote>
<section id="waiting-time-kpis" class="level3">
<h3 class="anchored" data-anchor-id="waiting-time-kpis">9.1. Waiting time KPIs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assumes df is monitored arrivals</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>waiting_time <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>waiting_time <span class="ot">&lt;-</span>df<span class="sc">$</span>end_time <span class="sc">-</span> df<span class="sc">$</span>start_time <span class="sc">-</span> df<span class="sc">$</span>activity_time  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>resource_waiting_times_by_replication <span class="ot">&lt;-</span> <span class="cf">function</span>(reps) {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - WAITING TIMES FOR RESOURCES - #</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"resource"</span>, <span class="st">"replication"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  waiting_times_wide <span class="ot">&lt;-</span> <span class="fu">get_mon_arrivals</span>(reps, <span class="at">per_resource=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># waiting time = end time - start time - activity time</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">waiting_time</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean waiting time in each replication</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(cols))) <span class="sc">%&gt;%</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean for each replication</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">rep_waiting_time=</span><span class="fu">mean</span>(waiting_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># recode kpi names</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">resource=</span><span class="fu">recode</span>(resource,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'triage_bay'</span><span class="ot">=</span><span class="st">'01a_triage_wait'</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'registration_clerk'</span><span class="ot">=</span><span class="st">'02a_registration_wait'</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'examination_room'</span><span class="ot">=</span><span class="st">'03a_examination_wait'</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'nontrauma_treat_cubicle'</span><span class="ot">=</span><span class="st">'04a_treatment_wait(non_trauma)'</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'trauma_room'</span><span class="ot">=</span><span class="st">'06a_stabilisation_wait'</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'trauma_treat_cubicle'</span><span class="ot">=</span><span class="st">'07a_treatment_wait(trauma)'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># organise</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(resource) <span class="sc">%&gt;%</span> </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># long to wide format ...</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spread</span>(resource, rep_waiting_time)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(waiting_times_wide)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="resource-utilisation-kpis" class="level3">
<h3 class="anchored" data-anchor-id="resource-utilisation-kpis">9.2. Resource utilisation KPIs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>get_resource_counts <span class="ot">&lt;-</span> <span class="cf">function</span>(exp) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  resource <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"triage_bay"</span>, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"registration_clerk"</span>, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">"examination_room"</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"trauma_room"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"trauma_treat_cubicle"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"nontrauma_treat_cubicle"</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  resource_counts <span class="ot">=</span> <span class="fu">c</span>(exp<span class="sc">$</span>n_triage_bays,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                      exp<span class="sc">$</span>n_reg_clerks,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                      exp<span class="sc">$</span>n_exam_rooms,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>                      exp<span class="sc">$</span>n_trauma_rooms,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                      exp<span class="sc">$</span>n_trauma_cubicles,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>                      exp<span class="sc">$</span>n_non_trauma_cubicles)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  df_resource <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(resource)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  df_resource<span class="sc">$</span>count <span class="ot">&lt;-</span> resource_counts</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_resource)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># simple calculation of total busy time / total scheduled resource time.</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>resource_utilisation <span class="ot">&lt;-</span> <span class="cf">function</span>(df, scheduled_time){</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>   df<span class="sc">$</span>util <span class="ot">=</span> df<span class="sc">$</span>in_use <span class="sc">/</span> (scheduled_time <span class="sc">*</span> df<span class="sc">$</span>count)  </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(df)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate resource utilisation and return table (rows = reps and cols = resources)</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>resource_utilisation_by_replication <span class="ot">&lt;-</span> <span class="cf">function</span>(reps, results_collection_period){</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get results dataframe broken down by resource and replication.</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"resource"</span>, <span class="st">"replication"</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># utilisation calculation:</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple calculation of total busy time / total scheduled resource time.</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># where total scheduled time = n_resource * results collection period.</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  util_wide <span class="ot">&lt;-</span> <span class="fu">get_mon_arrivals</span>(reps, <span class="at">per_resource=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># total activity time in each replication per resource (long format)</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(cols))) <span class="sc">%&gt;%</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">in_use=</span><span class="fu">sum</span>(activity_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># merge with the number of resources available</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">merge</span>(<span class="fu">get_resource_counts</span>(exp), <span class="at">by=</span><span class="st">"resource"</span>, <span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the utilisation using scheduled resource availability</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resource_utilisation</span>(results_collection_period) <span class="sc">%&gt;%</span> </span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop total activity time and count of resources</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">select =</span> <span class="fu">c</span>(replication, resource, util)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># recode names</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">resource=</span><span class="fu">recode</span>(resource,</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'triage_bay'</span><span class="ot">=</span><span class="st">'01b_triage_util'</span>,</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'registration_clerk'</span><span class="ot">=</span><span class="st">'02b_registration_util'</span>,</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'examination_room'</span><span class="ot">=</span><span class="st">'03b_examination_util'</span>,</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'nontrauma_treat_cubicle'</span><span class="ot">=</span><span class="st">'04b_treatment_util(non_trauma)'</span>,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'trauma_room'</span><span class="ot">=</span><span class="st">'06b_stabilisation_util'</span>,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'trauma_treat_cubicle'</span><span class="ot">=</span><span class="st">'07b_treatment_util(trauma)'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(resource) <span class="sc">%&gt;%</span> </span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># long to wide format...</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spread</span>(resource, util)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(util_wide)</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="patient-arrival-numbers-output" class="level3">
<h3 class="anchored" data-anchor-id="patient-arrival-numbers-output">9.3. Patient arrival numbers output</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of arrivals in each replication</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>arrivals_by_replication <span class="ot">&lt;-</span> <span class="cf">function</span>(envs){</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(env <span class="cf">in</span> envs){</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">c</span>(results, <span class="fu">get_n_generated</span>(env, <span class="st">"Patient"</span>))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">replication =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(results)), </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">arrivals =</span> results)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"replication"</span>, <span class="st">"00_arrivals"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="system-level-kpis" class="level3">
<h3 class="anchored" data-anchor-id="system-level-kpis">9.4 System level KPIs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mean time in the system and throughput</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>system_kpi_for_rep_i <span class="ot">&lt;-</span> <span class="cf">function</span>(reps, rep_i){</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get attributes</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  att <span class="ot">&lt;-</span> <span class="fu">get_mon_attributes</span>(reps)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for speed - limit to replication number.</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  data_wide <span class="ot">&lt;-</span> <span class="fu">subset</span>(att[att<span class="sc">$</span>replication <span class="sc">==</span> rep_i,], <span class="at">select =</span> <span class="fu">c</span>(name, key, value)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">spread</span>(key, value)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Patient type 1: trauma</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take the mean and ignore patients still in pathway</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  mean_time_1 <span class="ot">=</span> <span class="fu">mean</span>(data_wide[data_wide<span class="sc">$</span>patient_type <span class="sc">==</span> <span class="dv">1</span>,]<span class="sc">$</span>total_time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Patient type 2: non_trauma</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take the mean and ignore patients still in pathway</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  mean_time_2 <span class="ot">=</span> <span class="fu">mean</span>(data_wide[data_wide<span class="sc">$</span>patient_type <span class="sc">==</span> <span class="dv">2</span>,]<span class="sc">$</span>total_time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Throughput - discharges during opening hours.</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  throughput <span class="ot">&lt;-</span> <span class="fu">sum</span>(data_wide<span class="sc">$</span>departed, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store and return data.frame of results</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  rep_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"replication"</span> <span class="ot">=</span> rep_i,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"05_total_time(non-trauma)"</span> <span class="ot">=</span> mean_time_2,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"08_total_time(trauma)"</span> <span class="ot">=</span> mean_time_1, </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"09_throughput"</span><span class="ot">=</span> throughput)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(rep_results) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"replication"</span>,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"05_total_time(non-trauma)"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"08_total_time(trauma)"</span>, </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"09_throughput"</span>)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rep_results)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>system_kpi_by_replication <span class="ot">&lt;-</span> <span class="cf">function</span>(reps){</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calcs total time by patient type and total throughput</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># empty dataframe for attribute calculations.</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  att_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">nrow =</span> <span class="dv">0</span>))</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(att_results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"replication"</span>, </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"05_total_time(non-trauma)"</span>, </span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"08_total_time(trauma)"</span>, </span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"_09_throughput"</span>)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add each rep separately as this works faster with pivot</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(rep_i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(reps)){</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    att_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(att_results, <span class="fu">system_kpi_for_rep_i</span>(reps, rep_i))</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return the KPIs by replications</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(att_results)</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-create-the-replications-table" class="level3">
<h3 class="anchored" data-anchor-id="function-to-create-the-replications-table">9.5. Function to create the replications table</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>replication_results_table <span class="ot">&lt;-</span> <span class="cf">function</span>(reps, results_collection_period){</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate and merge all results tables on the replication column</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  results_table <span class="ot">&lt;-</span> <span class="fu">arrivals_by_replication</span>(reps) <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">merge</span>(<span class="fu">resource_waiting_times_by_replication</span>(reps), <span class="at">by=</span><span class="st">"replication"</span>, <span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">merge</span>(<span class="fu">resource_utilisation_by_replication</span>(reps, </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                                              results_collection_period), </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">by=</span><span class="st">"replication"</span>, <span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">merge</span>(<span class="fu">system_kpi_by_replication</span>(reps), <span class="at">by=</span><span class="st">"replication"</span>, <span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sort by column names to get "replication" followed by ordered 00_, 01a, 01b and so on...</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(replication, <span class="fu">sort</span>(tidyselect<span class="sc">::</span><span class="fu">peek_vars</span>()))</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  results_table </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>rep_table <span class="ot">&lt;-</span> <span class="fu">replication_results_table</span>(reps, DEFAULT_RESULTS_COLLECTION_PERIOD)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rep_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">replication</th>
<th style="text-align: right;">00_arrivals</th>
<th style="text-align: right;">01a_triage_wait</th>
<th style="text-align: right;">01b_triage_util</th>
<th style="text-align: right;">02a_registration_wait</th>
<th style="text-align: right;">02b_registration_util</th>
<th style="text-align: right;">03a_examination_wait</th>
<th style="text-align: right;">03b_examination_util</th>
<th style="text-align: right;">04a_treatment_wait(non_trauma)</th>
<th style="text-align: right;">04b_treatment_util(non_trauma)</th>
<th style="text-align: right;">05_total_time(non-trauma)</th>
<th style="text-align: right;">06a_stabilisation_wait</th>
<th style="text-align: right;">06b_stabilisation_util</th>
<th style="text-align: right;">07a_treatment_wait(trauma)</th>
<th style="text-align: right;">07b_treatment_util(trauma)</th>
<th style="text-align: right;">08_total_time(trauma)</th>
<th style="text-align: right;">09_throughput</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">227</td>
<td style="text-align: right;">38.510472</td>
<td style="text-align: right;">0.6500712</td>
<td style="text-align: right;">55.63581</td>
<td style="text-align: right;">0.8313868</td>
<td style="text-align: right;">33.71627</td>
<td style="text-align: right;">0.8440569</td>
<td style="text-align: right;">161.3438</td>
<td style="text-align: right;">0.8528225</td>
<td style="text-align: right;">224.4021</td>
<td style="text-align: right;">322.3138</td>
<td style="text-align: right;">0.6826987</td>
<td style="text-align: right;">4.930242</td>
<td style="text-align: right;">0.2696664</td>
<td style="text-align: right;">448.4067</td>
<td style="text-align: right;">149</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">217</td>
<td style="text-align: right;">39.962735</td>
<td style="text-align: right;">0.5764697</td>
<td style="text-align: right;">92.59627</td>
<td style="text-align: right;">0.8241213</td>
<td style="text-align: right;">24.76566</td>
<td style="text-align: right;">0.8355781</td>
<td style="text-align: right;">120.8921</td>
<td style="text-align: right;">0.8715918</td>
<td style="text-align: right;">232.8177</td>
<td style="text-align: right;">341.0050</td>
<td style="text-align: right;">0.7482643</td>
<td style="text-align: right;">20.730095</td>
<td style="text-align: right;">0.3229111</td>
<td style="text-align: right;">501.7710</td>
<td style="text-align: right;">167</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">220</td>
<td style="text-align: right;">8.028919</td>
<td style="text-align: right;">0.5145182</td>
<td style="text-align: right;">125.19868</td>
<td style="text-align: right;">0.8363566</td>
<td style="text-align: right;">22.93733</td>
<td style="text-align: right;">0.8317090</td>
<td style="text-align: right;">151.4920</td>
<td style="text-align: right;">0.8235007</td>
<td style="text-align: right;">226.3541</td>
<td style="text-align: right;">175.9264</td>
<td style="text-align: right;">0.8472946</td>
<td style="text-align: right;">4.735720</td>
<td style="text-align: right;">0.4148506</td>
<td style="text-align: right;">273.4123</td>
<td style="text-align: right;">149</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">207</td>
<td style="text-align: right;">32.157743</td>
<td style="text-align: right;">0.5447273</td>
<td style="text-align: right;">100.08161</td>
<td style="text-align: right;">0.7600335</td>
<td style="text-align: right;">22.39284</td>
<td style="text-align: right;">0.7850996</td>
<td style="text-align: right;">104.7379</td>
<td style="text-align: right;">0.8154391</td>
<td style="text-align: right;">227.6200</td>
<td style="text-align: right;">217.9818</td>
<td style="text-align: right;">0.8518988</td>
<td style="text-align: right;">11.741513</td>
<td style="text-align: right;">0.3679632</td>
<td style="text-align: right;">358.0275</td>
<td style="text-align: right;">153</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">220</td>
<td style="text-align: right;">17.281597</td>
<td style="text-align: right;">0.5382466</td>
<td style="text-align: right;">95.79616</td>
<td style="text-align: right;">0.8497077</td>
<td style="text-align: right;">29.89311</td>
<td style="text-align: right;">0.8479559</td>
<td style="text-align: right;">124.9008</td>
<td style="text-align: right;">0.8803980</td>
<td style="text-align: right;">213.6180</td>
<td style="text-align: right;">163.9983</td>
<td style="text-align: right;">0.6404862</td>
<td style="text-align: right;">5.159307</td>
<td style="text-align: right;">0.1560905</td>
<td style="text-align: right;">347.3643</td>
<td style="text-align: right;">145</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">244</td>
<td style="text-align: right;">19.722275</td>
<td style="text-align: right;">0.6032575</td>
<td style="text-align: right;">139.37281</td>
<td style="text-align: right;">0.8861767</td>
<td style="text-align: right;">13.59604</td>
<td style="text-align: right;">0.8731107</td>
<td style="text-align: right;">150.0938</td>
<td style="text-align: right;">0.8974080</td>
<td style="text-align: right;">247.6859</td>
<td style="text-align: right;">220.1141</td>
<td style="text-align: right;">0.8915800</td>
<td style="text-align: right;">5.252764</td>
<td style="text-align: right;">0.3437842</td>
<td style="text-align: right;">310.7147</td>
<td style="text-align: right;">167</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="histogram-of-replications" class="level3">
<h3 class="anchored" data-anchor-id="histogram-of-replications">9.6 Histogram of replications</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>histogram_of_replications <span class="ot">&lt;-</span> <span class="cf">function</span>(rep_table, column_name, unit_label, <span class="at">n_bins=</span><span class="dv">10</span>){</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Divide the x range for selected column into n_bins</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  binwidth <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">range</span>(<span class="fu">select</span>(rep_table, <span class="fu">all_of</span>(column_name))))<span class="sc">/</span>n_bins</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(rep_table, <span class="fu">aes</span>(.data[[column_name]])) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> binwidth, <span class="at">fill=</span><span class="st">"steelblue"</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="fu">paste</span>(column_name, <span class="st">" ("</span>, unit_label, <span class="st">")"</span>)) <span class="sc">+</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Replications"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(g)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># as numeric names make sure to pass column name in ticks ``</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram_of_replications</span>(rep_table, <span class="st">"09_throughput"</span>, <span class="st">"patients/day"</span>, <span class="at">n_bins=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01_model_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="results-summary-table" class="level3">
<h3 class="anchored" data-anchor-id="results-summary-table">9.7 Results summary table</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># modified summary table function</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>create_summary_table <span class="ot">&lt;-</span> <span class="cf">function</span>(rep_table, exp, <span class="at">dp=</span><span class="dv">2</span>){</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mean of all columns, but ignore rep number</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  mean_values <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">colMeans</span>(rep_table[<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(rep_table))]))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mean_values) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mean"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">round</span>(mean_values, dp))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">create_summary_table</span>(rep_table, exp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">00_arrivals</td>
<td style="text-align: right;">227.28</td>
</tr>
<tr class="even">
<td style="text-align: left;">01a_triage_wait</td>
<td style="text-align: right;">34.24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01b_triage_util</td>
<td style="text-align: right;">0.60</td>
</tr>
<tr class="even">
<td style="text-align: left;">02a_registration_wait</td>
<td style="text-align: right;">104.06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">02b_registration_util</td>
<td style="text-align: right;">0.83</td>
</tr>
<tr class="even">
<td style="text-align: left;">03a_examination_wait</td>
<td style="text-align: right;">23.60</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03b_examination_util</td>
<td style="text-align: right;">0.83</td>
</tr>
<tr class="even">
<td style="text-align: left;">04a_treatment_wait(non_trauma)</td>
<td style="text-align: right;">126.82</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04b_treatment_util(non_trauma)</td>
<td style="text-align: right;">0.86</td>
</tr>
<tr class="even">
<td style="text-align: left;">05_total_time(non-trauma)</td>
<td style="text-align: right;">229.06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06a_stabilisation_wait</td>
<td style="text-align: right;">217.85</td>
</tr>
<tr class="even">
<td style="text-align: left;">06b_stabilisation_util</td>
<td style="text-align: right;">0.74</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07a_treatment_wait(trauma)</td>
<td style="text-align: right;">7.22</td>
</tr>
<tr class="even">
<td style="text-align: left;">07b_treatment_util(trauma)</td>
<td style="text-align: right;">0.27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">08_total_time(trauma)</td>
<td style="text-align: right;">354.38</td>
</tr>
<tr class="even">
<td style="text-align: left;">09_throughput</td>
<td style="text-align: right;">154.86</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>